# https://www.notion.so/wekaio/Synthesia-Testing-15-Million-File-Retrieval-from-S3-Object-Store-Tier-31e79b29217645a8aaf4d0d558d746f8?pvs=4
#
# $ weka user login admin Changeme12\!\@
#
# $ weka fs
# FILESYSTEM ID  FILESYSTEM NAME  USED SSD  AVAILABLE SSD  USED TOTAL  AVAILABLE TOTAL  THIN PROVISIONED  THIN PROVISIONED MINIMUM SSD  THIN PROVISIONED MAXIMUM SSD
# 0              jtest-fs01       20.47 KB  7.51 GB        20.47 KB    7.51 GB          False

# Checking
# Command: weka fs tier s3 add
# weka fs tier obs add jtest-obs-tier01
# weka fs tier obs update jtest-obs-tier01
# weka fs tier ops
# weka fs tier obs delete jtest-obs-tier01


#
- name: Add Customer Object Store
  shell: |
    weka fs tier obs add jtest-obs01
  register: add_custom_obs
  when: inventory_hostname in hostvars[groups['workers'][0]]['ansible_hostname']
- debug: msg={{ add_custom_obs }}

#
#- name: Reduce the size of the 'jtest-obs-fs01' file system if present
#  shell: |
#    weka fs update --total-capacity 10GB jtest-obs-fs01
#  register: reduce_obs_fs_size
#  when: inventory_hostname in hostvars[groups['workers'][0]]['ansible_hostname']
#- debug: msg={{ reduce_obs_fs_size }}

#
- name:  Check WekaFS
  shell: |
    weka fs
  register: check_wekafs
  when: inventory_hostname in hostvars[groups['workers'][0]]['ansible_hostname']
- debug: msg={{ check_wekafs }}

#
- name: Attach and Object Store Bucket. (Use your own bucket details)
  shell: |
    weka fs tier s3 add jtest-obs-tier01 --site local --obs-name jtest-obs01 \
    --hostname=minio.jtest.pivotal.io --port=9000 --bucket=jbucket01 --auth-method AWSSignature2 \
    --region=us-east-1 --protocol=HTTPS --access-key-id=minioadmin --secret-key=changeme --skip-verification
  register: attach_obs_bucket
  when: inventory_hostname in hostvars[groups['workers'][0]]['ansible_hostname']
- debug: msg={{ attach_obs_bucket }}

#
- name: For this example make the Tiering policy more aggressive. (30s in this case).
  shell: |
    weka fs group update jtest-obs-grp01 --start-demote=10
  register: update_obs_fs_grp
  when: inventory_hostname in hostvars[groups['workers'][0]]['ansible_hostname']
- debug: msg={{ update_obs_fs_grp }}

#
- name: For this example make the Tiering policy more aggressive. (30s in this case).
  shell: |
    weka fs group update jtest-obs-grp01 --start-demote=30
  register: update_obs_fs_grp
  when: inventory_hostname in hostvars[groups['workers'][0]]['ansible_hostname']
- debug: msg={{ update_obs_fs_grp }}

#
################################################################################
# Mount the s3fs filesystem on the backends and clients if you have them.
# Backends

# Clients (replace ip with one of your backends)
# sudo mkdir /mnt/jtest-s3fs01
# sudo mount -t wekafs 192.168.0.181/jtest-s3fs01 /mnt/jtest-s3fs01


# Mount the jtest-s3fs01 filesystem on the backends and clients if you have them.
# Backends
#
# sudo mkdir /mnt/jtest-s3fs01
# sudo chmod 777 /mnt/jtest-s3fs01

# sudo chown root:root /mnt/jtest-s3fs01
# sudo mount -t wekafs jtest-s3fs01 /mnt/jtest-s3fs01
